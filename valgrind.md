#Valgrind

##Memcheck

**memcheck** is the default tool used by Valgrind. It is intended to idendify memory related problems, which mainly include:

+ Memory leak (e.g., `malloc` without `free`, `new` without `delete`, etc.)
+ Illegal access (e.g., "one past the end" access, dangling pointer access)
+ Usage of Uninitialized memory (cause of plenty of mysterious bugs ...)

```bash
valgrind --leak-check=yes  --read-var-info=yes ./myapp
```

**You should compile your program with debug information** (e.g., `gcc -g`).

For memory problems, Valgrind will typically show:

1. Where the illegal access happens (which line of code)
2. Where it is allocated (if any)
3. Where it is free'd (if any)

Options:

1. `--read-var-info=yes`: provide more detailed information about illegal access location.
2. `--leak-check=yes`: check for memory leaks

### Use case: debugging Postgres

*PostgreSQL* is a DMBS that uses a multi-process model for parallel execution. 
When debugging, I want to debug all spawned processes by the master.

```bash
valgrind --tool=memcheck --leak-check=yes --track-origins=yes --trace-children=yes --db-attach=yes --log-file="valgrind.log" pg_ctl -D ./data start 
```

Options:

1. `--tool=memcheck`: default, can be omitted
2. `--track-origins=yes`: show the sources of uninitialised data
3. `--trace-children=yes`: monitor all spawned child processes as well (NB: this is for **multi-process**, not **multi-thread**. Multi-thread is monitored automatically. However, the parallel behavior under Valgrind may be different from reality. So synchronization problem may not show.)
4. `--db-attach=yes`: attach to **gdb** when error occurs


##Callgrind

[Official Manual](http://valgrind.org/docs/manual/cl-manual.html)

Callgrind generates a **call-graph**, showing caller-callee relationships, counting functions calls and counting Ir (instruction references) (by default). It can also simulate cache misses and branch predictions, by setting command line flags.

```bash
valgrind --tool=callgrind ./myapp
```

It will generate a profile file like *callgrind.out.4990*. The session number may change.

###Profiling only selected piece of code

Insert the macros in your source code:

```cpp
#include  <valgrind/callgrind.h>

//code before

CALLGRIND_START_INSTRUMENTATION;
//the meat
//...
CALLGRIND_STOP_INSTRUMENTATION;
CALLGRIND_DUMP_STATS;

//code after
```

On the command line, start profiling with

```bash
 valgrind --tool=callgrind --instr-atstart=no ./myapp
```

###Visualizing profile with *kcachegrind*

**Kcachegrind** is a GUI that display the profile generated by valgrind.
```bash
kcachegrind callgrind.out.4990
```



